---
title: "CeNGEN bulk RNAseq Data PCA and DESeq"
output: html_document
---

#FIRST

# See 'Type vs type DESeq comparisons.Rmd' for statistical summaries and outputs

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# DESeq setup
```{r}
setwd("C:/Users/xcwol/Downloads") # Change your working directory!

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
 
BiocManager::install("DESeq2")
library(DESeq2)
library(ggplot2)
library(stringr)
library(dplyr)
library(reshape2)
library(RColorBrewer)
library(pheatmap)
library(tidyverse)
library(broom)
library(ggfortify)
```

```{r}
save.image("C:/Your/Directory/.RData")
load("C:/Your/Directory/.RData")
```

# Create a count matrix using HTSeq results:
```{r}
# Identify the directory containing the .txt files
directory_path <- "C:/Your/Directory"

# Load the file paths
file_paths <- list.files(directory_path, pattern = "\\_counts.txt$", full.names = TRUE)

# Initialize variables
count_matrix <- NULL
sample_names <- NULL

# Iterate through the files and extract the counts
for (i in file_paths) {
  sample_name <- tools::file_path_sans_ext(basename(i))  # Extract sample name
  sample_names <- c(sample_names, sample_name)
  
  counts <- read_delim(i, delim = "\t", col_names = FALSE, col_types = cols_only(col_character(), col_integer()))
  count_matrix <- cbind(count_matrix, counts[[2]])
}

# Convert count matrix to matrix format, then add replicate names and gene names:
count_matrix <- as.matrix(count_matrix)
count_matrix <- count_matrix[1:(nrow(count_matrix)-5),]
colnames(count_matrix) <- str_remove(sample_names, "_counts")
genenames <- read.csv("genenames.csv")
rownames(count_matrix) <- genenames[,1]

# Save count matrix as a .csv file
write.csv(count_matrix, file = "count_matrix.csv", row.names = TRUE)

# Print the count matrix and sample names
print(count_matrix)
print(sample_names)
```

# If you already have a count matrix from another source as a .csv, load it here:
```{r}
#bulkData <- read.csv("Barrett_et_al_2022_CeNGEN_bulk_RNAseq_data.csv")
```
```

# Transform your bulk RNA-seq data:
```{r}
#t_PCA <- prcomp(t(bulkData[,2:161])) # I had 160 total samples, so I am  using columns 2:161 for my principal component analysis
t_PCA <- prcomp(t(count_matrix))
```

# Unweighted for read depth or STDev (will do in DESeq later):
```{r}
print(t_PCA)

plot(t_PCA$x, type = "p", cex = 1, pch = 16)

title(main = "PCA Plot of Transposed Gene Data PCs 1-2")
```

# Add your gene names to the PCA:
```{r}
rownames(t_PCA$rotation) <- make.names(1:nrow(genenames))

list(sort(t_PCA$rotation[,1], decreasing = TRUE)[1:10])
list(sort(t_PCA$rotation[,1], decreasing = FALSE)[1:10])

list(sort(t_PCA$rotation[,2], decreasing = TRUE)[1:10])
list(sort(t_PCA$rotation[,2], decreasing = FALSE)[1:10])

list(sort(t_PCA$rotation[,3], decreasing = TRUE)[1:10])
list(sort(t_PCA$rotation[,3], decreasing = FALSE)[1:10])
```


# Make your cts object and run DESeq:
```{r}
#cts <- read.table("Barrett_et_al_2022_CeNGEN_bulk_RNAseq_data.csv", header=TRUE, sep=",", row.names=1)
cts <- count_matrix
# make a condition table
condition = read.table("experimental_conditions_46_neurons.csv", header = TRUE, sep=",", row.names=1)

dds <- DESeqDataSetFromMatrix(countData = cts, colData = condition, design= ~ type)
dds <- DESeq(dds)
resultsNames(dds)

dds <- estimateSizeFactors(dds)
sizeFactors(dds)
normalized_counts <- counts(dds, normalized=TRUE)
#normalized_countsdata <- write.csv(normalized_counts, file="normalized_counts.csv", sep="\t", quote = F, col.names = NA) # Use for UMAP later
```

```{r}
write.csv(normalized_counts, file = "normalized_counts.csv")
```


# Re-order results
```{r}
res <- results(dds)
res[order(res$padj),]
```


# Insert desired res object below:
```{r}
with(res, plot(log2FoldChange, -log10(pvalue), pch = 18, main="", xlim=c(-4,4), ylim=c(2,35)))

with(subset(res, padj<.05 ), points(log2FoldChange, -log10(pvalue), pch=18, col="black"))
with(subset(res, padj<.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(pvalue), pch=18, col="red"))
```

```{r}
with(subset(res, padj<.01 ), print(log2FoldChange))
with(subset(res, padj<.01 ), print(res$rownames)) # rownames are NULL
with(res, print(pvalue)) # Already re-ordered from smallest to largest (2 chunks above)
```

# Now, we are only interested in significant results:
```{r}
sig_res <- res[(res$padj<.05 & abs(res$log2FoldChange)>2 & !is.na(res$padj) & !is.na(row.names(res))) ,]
write.csv(sig_res, file="sig_results")

plotMA(res, ylim=c(-10,10))
plotMA(sig_res, ylim=c(-10,10))
```

# PCA plots:
```{r}
vsd <- vst(dds, blind=FALSE)

plotPCA(vsd, intgroup="condition") 
plotPCA(vsd, intgroup="type")

normalized_counts_assay <- assay(vsd)
```

# Heatmaps of DESeq data:
```{r}
select <- order(rowMeans(counts(dds,normalized=TRUE)),
                decreasing=TRUE)[1:25]

df <- as.data.frame(colData(dds)[,c("condition","type")])
pheatmap(assay(vsd)[select,], cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, annotation_col=df, fontsize = 7.5)

df <- as.data.frame(colData(dds)[1:40,c("condition","type")])
pheatmap(assay(vsd)[select,1:40], cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, annotation_col=df, fontsize = 7.5)

df <- as.data.frame(colData(dds)[41:80,c("condition","type")])
pheatmap(assay(vsd)[select,41:80], cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, annotation_col=df, fontsize = 7.5)

df <- as.data.frame(colData(dds)[81:120,c("condition","type")])
pheatmap(assay(vsd)[select,81:120], cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, annotation_col=df, fontsize = 7.5)

df <- as.data.frame(colData(dds)[121:160,c("condition","type")])
pheatmap(assay(vsd)[select,121:160], cluster_rows=FALSE, show_rownames=FALSE,
         cluster_cols=FALSE, annotation_col=df, fontsize = 7.5)
```

# Get sample distances:
```{r}
sampleDists <- dist(t(assay(vsd)))
```

# Heatmaps of Individual Replicates:
```{r}
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colnames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(250)
pheatmap(sampleDistMatrix[1:40,1:40], # Change rows and columns for clearer view
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         cluster_rows = F,
         cluster_cols = F,
         fontsize = 7)

sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colnames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(250)
pheatmap(sampleDistMatrix[41:80,41:80], # Change rows and columns for clearer view
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         cluster_rows = F,
         cluster_cols = F,
         fontsize = 7,
         col=colors)

sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colnames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(250)
pheatmap(sampleDistMatrix[81:160,81:160], # Change rows and columns for clearer view
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         cluster_rows = F,
         cluster_cols = F,
         fontsize = 6,
         col=colors)

sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colnames(sampleDistMatrix) <- paste(vsd$type, sep=":")
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(250)
pheatmap(sampleDistMatrix, # Change rows and columns for clearer view
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         cluster_rows = F,
         cluster_cols = F,
         fontsize = 7,
         col=colors)
```
